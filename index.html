<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Grammar Drill</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 28px;
        }

        h2 {
            color: #555;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .welcome-text {
            font-size: 20px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .menu-button {
            display: block;
            width: 100%;
            margin-bottom: 15px;
            background: #48bb78;
        }

        .menu-button:hover {
            background: #38a169;
        }

        .back-button {
            background: #f56565;
            padding: 10px 20px;
            font-size: 16px;
        }

        .back-button:hover {
            background: #e53e3e;
        }

        .navigation-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }

        .button-row {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 350px;
        }
        
        .navigation-buttons .back-button {
            margin-top: 10px;
        }

        .nav-button {
            background: #4299e1;
            padding: 10px 25px;
            font-size: 16px;
        }

        .nav-button:hover {
            background: #3182ce;
        }

        .exercise-container {
            background: #f7fafc;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .sentence {
            font-size: 20px;
            color: #2d3748;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .sentence:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }

        .exercise-title {
            font-size: 18px;
            color: #718096;
            margin-bottom: 20px;
            font-style: italic;
        }

        .hidden {
            display: none;
        }

        .verb-info {
            background: #bee3f8;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
            color: #2c5282;
        }

        .scheme-info {
            font-size: 14px;
            color: #718096;
            margin-bottom: 10px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #e53e3e;
            font-size: 14px;
            margin-top: 10px;
            padding: 10px;
            background: #fed7d7;
            border-radius: 8px;
        }

        .api-setup {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .api-setup input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            margin: 10px 0;
        }

        .api-setup label {
            display: block;
            color: #4a5568;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .nav-button.next-button {
            background: #48bb78;
        }
        
        .nav-button.next-button:hover {
            background: #38a169;
        }
        
        .russian {
            font-size: 28px;
            color: #5a67d8;
            font-weight: bold;
            margin-bottom: 20px;
            padding: 20px;
            background: #e6f2ff;
            border-radius: 10px;
            text-align: center;
            display: block !important;
        }
        
        .english {
            font-size: 22px;
            color: #2d3748;
            margin: 10px 0;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            transition: all 0.3s ease;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }
        
        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }
        
        .test-item {
            cursor: pointer;
            user-select: none;
            width: 100%;
        }
        
        #testContainer {
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        #testContainer:after {
            content: 'Tap to reveal';
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 14px;
            color: #a0aec0;
            font-style: italic;
        }
        
        #testContainer.complete:after {
            content: 'Complete! Try a new example';
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }
            
            button {
                padding: 12px 25px;
                font-size: 16px;
            }
            
            .navigation-buttons {
                justify-content: center;
            }
            
            .nav-button {
                margin: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="screen">
            <h1>Welcome, learner!</h1>
            <p class="welcome-text">Let's go and get you fluency NOW!</p>
            <button onclick="showApiSetup()">GO!</button>
        </div>

        <!-- API Setup -->
        <div id="apiSetup" class="screen hidden">
            <h2>Setup Your Learning Assistant</h2>
            <div class="api-setup">
                <label for="apiEndpoint">API Endpoint URL:</label>
                <input type="text" id="apiEndpoint" placeholder="https://your-backend.vercel.app/api/conjugate">
                <p style="font-size: 14px; color: #718096; margin-top: 5px;">
                    Enter your backend URL that handles Anthropic API requests
                </p>
            </div>
            <button onclick="saveApiSettings()">Continue</button>
            <button class="back-button" onclick="showWelcome()">Back</button>
        </div>

        <!-- Main Menu -->
        <div id="mainMenu" class="screen hidden">
            <h1>Main Menu</h1>
            <button class="menu-button" onclick="showExercises()">Exercises</button>
            <button class="menu-button" onclick="showTestYourself()">Test Yourself</button>
        </div>

        <!-- Exercises Menu -->
        <div id="exercisesMenu" class="screen hidden">
            <h2>Core Grammar</h2>
            <button class="menu-button" onclick="startPresentSimple()">Present Simple</button>
            <button class="menu-button" onclick="startPastSimple()">Past Simple</button>
            <button class="menu-button" onclick="startFutureSimple()">Future Simple</button>
            <button class="back-button" onclick="showMainMenu()">Back to Main Menu</button>
        </div>

        <!-- Present Simple Exercise -->
        <div id="presentSimple" class="screen hidden">
            <h2>Present Simple</h2>
            <p class="exercise-title">Practice changing subjects while keeping the same verb</p>
            
            <div class="verb-info" id="currentVerb">Current verb: go</div>
            <div class="scheme-info" id="schemeInfo">Loading...</div>
            
            <div class="exercise-container">
                <div id="sentenceDisplay">
                    <div class="sentence" id="sentence1">Loading...</div>
                    <div class="sentence" id="sentence2">Loading...</div>
                    <div class="sentence" id="sentence3">Loading...</div>
                    <div class="sentence" id="sentence4">Loading...</div>
                </div>
            </div>

            <div id="errorMessage" class="error-message hidden"></div>

            <div class="navigation-buttons">
                <button class="nav-button" id="backBtn" onclick="previousSubject()" disabled>Back</button>
                <button class="nav-button" id="changeWordBtn" onclick="changeVerb()">Change the Word</button>
                <button class="nav-button" id="nextBtn" onclick="nextSubject()">Next</button>
            </div>
            
            <button class="back-button" onclick="showExercises()">Back to Exercises</button>
        </div>

        <!-- Future Simple Exercise -->
        <div id="futureSimple" class="screen hidden">
            <h2>Future Simple</h2>
            <p class="exercise-title">Practice changing subjects with future tense</p>
            
            <div class="verb-info" id="currentVerbFuture">Current verb: go</div>
            <div class="scheme-info" id="schemeInfoFuture">Loading...</div>
            
            <div class="exercise-container">
                <div id="sentenceDisplayFuture">
                    <div class="sentence" id="sentenceFuture1">Loading...</div>
                    <div class="sentence" id="sentenceFuture2">Loading...</div>
                    <div class="sentence" id="sentenceFuture3">Loading...</div>
                    <div class="sentence" id="sentenceFuture4">Loading...</div>
                </div>
            </div>

            <div id="errorMessageFuture" class="error-message hidden"></div>

            <div class="navigation-buttons">
                <div class="button-row">
                    <button class="nav-button" id="backBtnFuture" onclick="previousSubjectFuture()">Back</button>
                    <button class="nav-button next-button" id="nextBtnFuture" onclick="nextSubjectFuture()">Next</button>
                </div>
                <div class="button-row">
                    <button class="nav-button" onclick="playAudioFuture()">üîä Play</button>
                    <button class="nav-button" id="changeWordBtnFuture" onclick="changeVerbFuture()">Change the Word</button>
                </div>
                <button class="back-button" onclick="showExercises()">Back to Exercises</button>
            </div>
        </div>

        <!-- Past Simple Exercise -->
        <div id="pastSimple" class="screen hidden">
            <h2>Past Simple</h2>
            <p class="exercise-title">Practice changing subjects with past tense</p>
            
            <div class="verb-info" id="currentVerbPast">Current verb: go</div>
            <div class="scheme-info" id="schemeInfoPast">Loading...</div>
            
            <div class="exercise-container">
                <div id="sentenceDisplayPast">
                    <div class="sentence" id="sentencePast1">Loading...</div>
                    <div class="sentence" id="sentencePast2">Loading...</div>
                    <div class="sentence" id="sentencePast3">Loading...</div>
                    <div class="sentence" id="sentencePast4">Loading...</div>
                </div>
            </div>

            <div id="errorMessagePast" class="error-message hidden"></div>

            <div class="navigation-buttons">
                <div class="button-row">
                    <button class="nav-button" id="backBtnPast" onclick="previousSubjectPast()">Back</button>
                    <button class="nav-button next-button" id="nextBtnPast" onclick="nextSubjectPast()">Next</button>
                </div>
                <div class="button-row">
                    <button class="nav-button" onclick="playAudioPast()">üîä Play</button>
                    <button class="nav-button" id="changeWordBtnPast" onclick="changeVerbPast()">Change the Word</button>
                </div>
                <button class="back-button" onclick="showExercises()">Back to Exercises</button>
            </div>
        </div>

        <!-- Test Yourself -->
        <div id="testYourself" class="screen hidden">
            <h2>Test Yourself</h2>
            <p class="exercise-title">Translate this sentence and put it in the negative, question and wh-question form.<br>Tap the example to see the translation.</p>
            
            <div class="exercise-container" id="testContainer" onclick="revealNext()">
                <div class="test-item">
                    <div class="russian" id="russianSentence">Loading...</div>
                    <div class="english hidden" id="englishPositive"></div>
                    <div class="english hidden" id="englishNegative"></div>
                    <div class="english hidden" id="englishQuestion"></div>
                    <div class="english hidden" id="englishWhQuestion"></div>
                </div>
            </div>
            
            <div id="testError" class="error-message hidden"></div>
            
            <div class="navigation-buttons">
                <button class="nav-button" onclick="generateNewTest()">New Example</button>
                <button class="back-button" onclick="showMainMenu()">Back to Main Menu</button>
            </div>
        </div>
    </div>

    <script>
        // Data
        const verbs = [
            // Original verbs
            'go', 'fix', 'get', 'work', 'play', 'study', 'eat', 'take', 'make', 'read', 'write', 'speak',
            // New irregular verbs from the table
            'be', 'beat', 'become', 'begin', 'break', 'bring', 'build', 'buy', 'catch', 'choose',
            'come', 'cost', 'do', 'draw', 'dream', 'drink', 'drive', 'fall', 'feel', 'find',
            'fly', 'give', 'grow', 'have', 'hear', 'know', 'learn', 'leave', 'lie', 'meet',
            'put', 'run', 'say', 'see', 'seek', 'show', 'sing', 'sit', 'sleep', 'stand',
            'swim', 'teach', 'tell', 'think', 'throw', 'understand'
        ];
        const allSubjects = ['I', 'you', 'he', 'she', 'it', 'we', 'they'];

        // State
        let currentVerb = 'go';
        let currentSubjectIndex = 0;
        let apiEndpoint = '';
        let isLoading = false;
        
        // State for Past Simple
        let currentVerbPast = 'go';
        let currentSubjectIndexPast = 0;
        
        // State for Future Simple
        let currentVerbFuture = 'go';
        let currentSubjectIndexFuture = 0;
        
        // Audio settings
        let audioEnabled = true;
        
        // Test Yourself state
        let currentTestData = null;
        let revealStage = 0;

        // Navigation functions
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        function showWelcome() {
            showScreen('welcomeScreen');
        }

        function showApiSetup() {
            // Check if API endpoint is already saved
            const savedEndpoint = localStorage.getItem('apiEndpoint');
            if (savedEndpoint) {
                apiEndpoint = savedEndpoint;
                showMainMenu();
            } else {
                showScreen('apiSetup');
            }
        }

        function saveApiSettings() {
            const endpoint = document.getElementById('apiEndpoint').value.trim();
            if (!endpoint) {
                alert('Please enter your API endpoint URL');
                return;
            }
            apiEndpoint = endpoint;
            localStorage.setItem('apiEndpoint', endpoint);
            showMainMenu();
        }

        function showMainMenu() {
            showScreen('mainMenu');
        }

        function showExercises() {
            showScreen('exercisesMenu');
        }

        function showTestYourself() {
            showScreen('testYourself');
            // Ensure proper initial state
            document.getElementById('russianSentence').style.display = 'block';
            document.querySelectorAll('.english').forEach(el => {
                el.style.display = 'none';
            });
            generateNewTest();
        }

        function startPresentSimple() {
            showScreen('presentSimple');
            currentSubjectIndex = 0;
            updateExerciseDisplay();
        }

        function startPastSimple() {
            showScreen('pastSimple');
            currentSubjectIndexPast = 0;
            updatePastSimpleDisplay();
        }

        // Future Simple Exercise Functions
        async function updateFutureSimpleDisplay() {
            if (isLoading) return;
            
            const subject = allSubjects[currentSubjectIndexFuture];
            
            // Show loading state
            setLoadingStateFuture(true);
            
            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        subject: subject,
                        verb: currentVerbFuture,
                        tense: 'future'
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                
                // Update sentences with API response
                document.getElementById('sentenceFuture1').textContent = data.sentences[0];
                document.getElementById('sentenceFuture2').textContent = data.sentences[1];
                document.getElementById('sentenceFuture3').textContent = data.sentences[2];
                document.getElementById('sentenceFuture4').textContent = data.sentences[3];
                
                // Update scheme info
                document.getElementById('schemeInfoFuture').textContent = 'Future Simple: will + base verb for all subjects';
                
                // Hide error message
                document.getElementById('errorMessageFuture').classList.add('hidden');
                
            } catch (error) {
                console.error('Error:', error);
                showErrorFuture('Failed to generate sentences. Using fallback logic.');
                useFallbackLogicFuture(subject);
            } finally {
                setLoadingStateFuture(false);
            }
            
            // Update navigation buttons (never disable them since we loop)
            // Update verb info
            document.getElementById('currentVerbFuture').textContent = `Current verb: ${currentVerbFuture}`;
        }

        function setLoadingStateFuture(loading) {
            isLoading = loading;
            const buttons = ['backBtnFuture', 'nextBtnFuture', 'changeWordBtnFuture'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) btn.disabled = loading;
            });
            
            if (loading) {
                document.querySelectorAll('#sentenceDisplayFuture .sentence').forEach(el => {
                    el.innerHTML = 'Generating... <span class="loading"></span>';
                });
            }
        }

        function showErrorFuture(message) {
            const errorEl = document.getElementById('errorMessageFuture');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        function useFallbackLogicFuture(subject) {
            // Simple fallback for future tense
            let whWord = getWhWord(currentVerbFuture);
            
            document.getElementById('sentenceFuture1').textContent = `${subject} will ${currentVerbFuture}`;
            document.getElementById('sentenceFuture2').textContent = `${subject} won't ${currentVerbFuture}`;
            document.getElementById('sentenceFuture3').textContent = `Will ${subject} ${currentVerbFuture}?`;
            document.getElementById('sentenceFuture4').textContent = `${whWord} will ${subject} ${currentVerbFuture}?`;
            
            document.getElementById('schemeInfoFuture').textContent = 'Future Simple: will + base verb for all subjects';
        }

        function nextSubjectFuture() {
            if (!isLoading) {
                currentSubjectIndexFuture++;
                if (currentSubjectIndexFuture >= allSubjects.length) {
                    currentSubjectIndexFuture = 0; // Loop back to beginning
                }
                updateFutureSimpleDisplay();
            }
        }

        function previousSubjectFuture() {
            if (!isLoading) {
                currentSubjectIndexFuture--;
                if (currentSubjectIndexFuture < 0) {
                    currentSubjectIndexFuture = allSubjects.length - 1; // Loop to end
                }
                updateFutureSimpleDisplay();
            }
        }

        function changeVerbFuture() {
            if (isLoading) return;
            
            // Get a random verb different from the current one
            let newVerb;
            do {
                newVerb = verbs[Math.floor(Math.random() * verbs.length)];
            } while (newVerb === currentVerbFuture);
            
            currentVerbFuture = newVerb;
            
            // Get a random subject
            currentSubjectIndexFuture = Math.floor(Math.random() * allSubjects.length);
            
            updateFutureSimpleDisplay();
        }

        // Audio Functions
        function speak(text) {
            if ('speechSynthesis' in window && audioEnabled) {
                // Cancel any ongoing speech
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.9; // Slightly slower for learning
                utterance.pitch = 1;
                utterance.volume = 1;
                
                window.speechSynthesis.speak(utterance);
            }
        }

        function playAudioPresent() {
            const sentences = [
                document.getElementById('sentence1').textContent,
                document.getElementById('sentence2').textContent,
                document.getElementById('sentence3').textContent,
                document.getElementById('sentence4').textContent
            ];
            
            // Speak all sentences with pauses
            let index = 0;
            function speakNext() {
                if (index < sentences.length) {
                    speak(sentences[index]);
                    index++;
                    setTimeout(speakNext, 2000); // 2 second pause between sentences
                }
            }
            speakNext();
        }

        // Test Yourself Functions
        async function generateNewTest() {
            // Reset reveal stage
            revealStage = 0;
            
            // Reset complete state
            document.getElementById('testContainer').classList.remove('complete');
            
            // Ensure Russian is visible and all English sentences are hidden
            document.getElementById('russianSentence').style.display = 'block';
            document.getElementById('russianSentence').classList.remove('hidden');
            document.querySelectorAll('.english').forEach(el => {
                el.classList.add('hidden');
                el.style.display = 'none';
            });
            
            // Show loading
            document.getElementById('russianSentence').textContent = 'Generating new example...';
            
            try {
                // Get random subject, verb, and tense
                const randomSubject = allSubjects[Math.floor(Math.random() * allSubjects.length)];
                const randomVerb = verbs[Math.floor(Math.random() * verbs.length)];
                const tenses = ['present', 'past', 'future'];
                const randomTense = tenses[Math.floor(Math.random() * tenses.length)];
                
                // Call API to generate test
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        subject: randomSubject,
                        verb: randomVerb,
                        tense: randomTense,
                        mode: 'test'
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                currentTestData = data;
                
                console.log('API Response:', data); // Debug log
                
                // Check if the API is returning a malformed Russian translation
                // (contains English words, parentheses, or looks wrong)
                if (data.russian && (
                    /^[A-Za-z\s]+/.test(data.russian) || // Starts with English
                    data.russian.includes('(') || // Contains parentheses
                    data.russian.includes(')') ||
                    /\b(I|you|he|she|it|we|they|will|won't|did|didn't|do|don't|does|doesn't)\b/i.test(data.russian) // Contains English pronouns/auxiliaries
                )) {
                    console.log('API returned malformed Russian, using fallback');
                    generateFallbackTest();
                    return;
                }
                
                // If we have proper Russian
                if (data.russian && data.sentences && data.sentences.length >= 3) {
                    // Display Russian translation
                    const russianEl = document.getElementById('russianSentence');
                    russianEl.textContent = data.russian;
                    russianEl.className = 'russian';
                    russianEl.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';
                    
                    // Handle both 3 and 4 sentence formats
                    let sentences = data.sentences;
                    if (sentences.length === 3) {
                        // If only 3 sentences, assume positive is missing
                        // Try to construct it from the data
                        const positive = data.russian.match(/^[A-Za-z\s]+/) ? data.russian : 'Error';
                        sentences = [positive, ...data.sentences];
                    }
                    
                    // Store English sentences (force hidden)
                    const englishIds = ['englishPositive', 'englishNegative', 'englishQuestion', 'englishWhQuestion'];
                    englishIds.forEach((id, index) => {
                        const el = document.getElementById(id);
                        if (sentences[index]) {
                            el.textContent = sentences[index];
                        }
                        el.className = 'english hidden';
                        el.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important;';
                    });
                } else {
                    // Use fallback for any other issues
                    generateFallbackTest();
                }
                
                // Hide error message
                document.getElementById('testError').classList.add('hidden');
                
            } catch (error) {
                console.error('Error:', error);
                // Don't show error message when using fallback
                document.getElementById('testError').classList.add('hidden');
                generateFallbackTest();
            }
        }
        
        function generateFallbackTest() {
            // Fallback test generation
            const randomSubject = allSubjects[Math.floor(Math.random() * allSubjects.length)];
            const randomVerb = verbs[Math.floor(Math.random() * verbs.length)];
            const tenses = ['present', 'past', 'future'];
            const randomTense = tenses[Math.floor(Math.random() * tenses.length)];
            
            // Natural Russian translations
            const russianTranslations = {
                present: {
                    'I go': '–Ø –∏–¥—É', 'you go': '–¢—ã –∏–¥—ë—à—å', 'he goes': '–û–Ω –∏–¥—ë—Ç',
                    'she goes': '–û–Ω–∞ –∏–¥—ë—Ç', 'it goes': '–û–Ω–æ –∏–¥—ë—Ç', 'we go': '–ú—ã –∏–¥—ë–º', 'they go': '–û–Ω–∏ –∏–¥—É—Ç',
                    'I eat': '–Ø –µ–º', 'you eat': '–¢—ã –µ—à—å', 'he eats': '–û–Ω –µ—Å—Ç',
                    'she eats': '–û–Ω–∞ –µ—Å—Ç', 'we eat': '–ú—ã –µ–¥–∏–º', 'they eat': '–û–Ω–∏ –µ–¥—è—Ç',
                    'I work': '–Ø —Ä–∞–±–æ—Ç–∞—é', 'he works': '–û–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç', 'they work': '–û–Ω–∏ —Ä–∞–±–æ—Ç–∞—é—Ç',
                    'I read': '–Ø —á–∏—Ç–∞—é', 'she reads': '–û–Ω–∞ —á–∏—Ç–∞–µ—Ç', 'we read': '–ú—ã —á–∏—Ç–∞–µ–º',
                    'I buy': '–Ø –ø–æ–∫—É–ø–∞—é', 'he buys': '–û–Ω –ø–æ–∫—É–ø–∞–µ—Ç', 'they buy': '–û–Ω–∏ –ø–æ–∫—É–ø–∞—é—Ç',
                    'I make': '–Ø –¥–µ–ª–∞—é', 'she makes': '–û–Ω–∞ –¥–µ–ª–∞–µ—Ç', 'we make': '–ú—ã –¥–µ–ª–∞–µ–º',
                    'I write': '–Ø –ø–∏—à—É', 'he writes': '–û–Ω –ø–∏—à–µ—Ç', 'they write': '–û–Ω–∏ –ø–∏—à—É—Ç',
                    'I speak': '–Ø –≥–æ–≤–æ—Ä—é', 'she speaks': '–û–Ω–∞ –≥–æ–≤–æ—Ä–∏—Ç', 'we speak': '–ú—ã –≥–æ–≤–æ—Ä–∏–º'
                },
                past: {
                    'I went': '–Ø —Ö–æ–¥–∏–ª(–∞)', 'you went': '–¢—ã —Ö–æ–¥–∏–ª(–∞)', 'he went': '–û–Ω —Ö–æ–¥–∏–ª',
                    'she went': '–û–Ω–∞ —Ö–æ–¥–∏–ª–∞', 'we went': '–ú—ã —Ö–æ–¥–∏–ª–∏', 'they went': '–û–Ω–∏ —Ö–æ–¥–∏–ª–∏',
                    'I ate': '–Ø –µ–ª(–∞)', 'he ate': '–û–Ω –µ–ª', 'she ate': '–û–Ω–∞ –µ–ª–∞',
                    'I worked': '–Ø —Ä–∞–±–æ—Ç–∞–ª(–∞)', 'they worked': '–û–Ω–∏ —Ä–∞–±–æ—Ç–∞–ª–∏',
                    'I bought': '–Ø –∫—É–ø–∏–ª(–∞)', 'he bought': '–û–Ω –∫—É–ø–∏–ª', 'she bought': '–û–Ω–∞ –∫—É–ø–∏–ª–∞',
                    'I made': '–Ø —Å–¥–µ–ª–∞–ª(–∞)', 'he made': '–û–Ω —Å–¥–µ–ª–∞–ª', 'they made': '–û–Ω–∏ —Å–¥–µ–ª–∞–ª–∏',
                    'I wrote': '–Ø –Ω–∞–ø–∏—Å–∞–ª(–∞)', 'she wrote': '–û–Ω–∞ –Ω–∞–ø–∏—Å–∞–ª–∞', 'we wrote': '–ú—ã –Ω–∞–ø–∏—Å–∞–ª–∏'
                },
                future: {
                    'I will go': '–Ø –ø–æ–π–¥—É', 'you will go': '–¢—ã –ø–æ–π–¥—ë—à—å', 'he will go': '–û–Ω –ø–æ–π–¥—ë—Ç',
                    'she will go': '–û–Ω–∞ –ø–æ–π–¥—ë—Ç', 'we will go': '–ú—ã –ø–æ–π–¥—ë–º', 'they will go': '–û–Ω–∏ –ø–æ–π–¥—É—Ç',
                    'I will eat': '–Ø –±—É–¥—É –µ—Å—Ç—å', 'he will eat': '–û–Ω –±—É–¥–µ—Ç –µ—Å—Ç—å',
                    'I will work': '–Ø –±—É–¥—É —Ä–∞–±–æ—Ç–∞—Ç—å', 'she will work': '–û–Ω–∞ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å',
                    'I will buy': '–Ø –∫—É–ø–ª—é', 'he will buy': '–û–Ω –∫—É–ø–∏—Ç', 'she will buy': '–û–Ω–∞ –∫—É–ø–∏—Ç',
                    'they will buy': '–û–Ω–∏ –∫—É–ø—è—Ç', 'we will buy': '–ú—ã –∫—É–ø–∏–º',
                    'I will make': '–Ø —Å–¥–µ–ª–∞—é', 'he will make': '–û–Ω —Å–¥–µ–ª–∞–µ—Ç', 'they will make': '–û–Ω–∏ —Å–¥–µ–ª–∞—é—Ç',
                    'I will write': '–Ø –Ω–∞–ø–∏—à—É', 'she will write': '–û–Ω–∞ –Ω–∞–ø–∏—à–µ—Ç', 'we will write': '–ú—ã –Ω–∞–ø–∏—à–µ–º'
                }
            };
            
            // Generate sentences based on tense
            let sentences = [];
            let russianSentence = '';
            let whWord = getWhWord(randomVerb);
            
            if (randomTense === 'present') {
                const verbForm = getVerbFormForSubject(randomSubject, randomVerb);
                const positive = `${randomSubject} ${verbForm}`;
                sentences = [
                    positive,
                    `${randomSubject} ${randomSubject === 'he' || randomSubject === 'she' || randomSubject === 'it' ? "doesn't" : "don't"} ${randomVerb}`,
                    `${randomSubject === 'he' || randomSubject === 'she' || randomSubject === 'it' ? "Does" : "Do"} ${randomSubject} ${randomVerb}?`,
                    `${whWord} ${randomSubject === 'he' || randomSubject === 'she' || randomSubject === 'it' ? "does" : "do"} ${randomSubject} ${randomVerb}?`
                ];
                russianSentence = russianTranslations.present[positive] || `${randomSubject} ${randomVerb} (–Ω–∞—Å—Ç–æ—è—â–µ–µ)`;
            } else if (randomTense === 'past') {
                const pastForm = getPastForm(randomVerb);
                const positive = `${randomSubject} ${pastForm}`;
                sentences = [
                    positive,
                    `${randomSubject} didn't ${randomVerb}`,
                    `Did ${randomSubject} ${randomVerb}?`,
                    `${whWord} did ${randomSubject} ${randomVerb}?`
                ];
                russianSentence = russianTranslations.past[positive] || generateGenericRussian(randomSubject, randomVerb, 'past');
            } else {
                const positive = `${randomSubject} will ${randomVerb}`;
                sentences = [
                    positive,
                    `${randomSubject} won't ${randomVerb}`,
                    `Will ${randomSubject} ${randomVerb}?`,
                    `${whWord} will ${randomSubject} ${randomVerb}?`
                ];
                russianSentence = russianTranslations.future[positive] || generateGenericRussian(randomSubject, randomVerb, 'future');
            }
            
            // Handle 'be' verb specially
            if (randomVerb === 'be') {
                if (randomTense === 'present') {
                    let beForm = randomSubject === 'I' ? 'am' : 
                               (randomSubject === 'he' || randomSubject === 'she' || randomSubject === 'it') ? 'is' : 'are';
                    sentences[0] = `${randomSubject} ${beForm}`;
                    sentences[1] = `${randomSubject} ${beForm} not`;
                    sentences[2] = `${beForm.charAt(0).toUpperCase() + beForm.slice(1)} ${randomSubject}?`;
                    sentences[3] = `Where ${beForm} ${randomSubject}?`;
                    russianSentence = `${randomSubject === 'I' ? '–Ø' : randomSubject === 'he' ? '–û–Ω' : 
                                      randomSubject === 'she' ? '–û–Ω–∞' : randomSubject === 'you' ? '–¢—ã' :
                                      randomSubject === 'we' ? '–ú—ã' : randomSubject === 'they' ? '–û–Ω–∏' : '–≠—Ç–æ'} 
                                      ${beForm === 'am' || beForm === 'is' ? '–µ—Å—Ç—å' : '–µ—Å—Ç—å'}`;
                } else if (randomTense === 'past') {
                    let wasWere = ['I', 'he', 'she', 'it'].includes(randomSubject) ? 'was' : 'were';
                    sentences[0] = `${randomSubject} ${wasWere}`;
                    sentences[1] = `${randomSubject} ${wasWere}n't`;
                    sentences[2] = `${wasWere.charAt(0).toUpperCase() + wasWere.slice(1)} ${randomSubject}?`;
                    sentences[3] = `Where ${wasWere} ${randomSubject}?`;
                    russianSentence = `${randomSubject === 'I' ? '–Ø –±—ã–ª(–∞)' : randomSubject === 'he' ? '–û–Ω –±—ã–ª' :
                                      randomSubject === 'she' ? '–û–Ω–∞ –±—ã–ª–∞' : randomSubject === 'you' ? '–¢—ã –±—ã–ª(–∞)' :
                                      randomSubject === 'we' ? '–ú—ã –±—ã–ª–∏' : randomSubject === 'they' ? '–û–Ω–∏ –±—ã–ª–∏' : '–≠—Ç–æ –±—ã–ª–æ'}`;
                }
            }
            
            // Display (ensure Russian visible, English hidden)
            const russianEl = document.getElementById('russianSentence');
            russianEl.textContent = russianSentence;
            russianEl.classList.remove('hidden');
            russianEl.style.display = 'block';
            
            const englishData = [
                {id: 'englishPositive', text: sentences[0]},
                {id: 'englishNegative', text: sentences[1]},
                {id: 'englishQuestion', text: sentences[2]},
                {id: 'englishWhQuestion', text: sentences[3]}
            ];
            
            englishData.forEach(item => {
                const el = document.getElementById(item.id);
                el.textContent = item.text;
                el.classList.add('hidden');
                el.style.display = 'none';
            });
            
            currentTestData = { sentences: sentences };
        }
        
        function generateGenericRussian(subject, verb, tense) {
            const russianSubjects = {
                'I': '–Ø', 'you': '–¢—ã', 'he': '–û–Ω', 'she': '–û–Ω–∞',
                'it': '–≠—Ç–æ', 'we': '–ú—ã', 'they': '–û–Ω–∏'
            };
            
            // Russian verb translations
            const verbTranslations = {
                // Movement
                'go': { present: '–∏–¥—ë—Ç', past: '—à—ë–ª/—à–ª–∞/—à–ª–æ', future: '–ø–æ–π–¥—ë—Ç' },
                'come': { present: '–ø—Ä–∏—Ö–æ–¥–∏—Ç', past: '–ø—Ä–∏—à—ë–ª/–ø—Ä–∏—à–ª–∞', future: '–ø—Ä–∏–¥—ë—Ç' },
                'drive': { present: '–µ–¥–µ—Ç', past: '–µ—Ö–∞–ª/–µ—Ö–∞–ª–∞', future: '–ø–æ–µ–¥–µ—Ç' },
                'fly': { present: '–ª–µ—Ç–∞–µ—Ç', past: '–ª–µ—Ç–∞–ª/–ª–µ—Ç–∞–ª–∞', future: '–ø–æ–ª–µ—Ç–∏—Ç' },
                'run': { present: '–±–µ–∂–∏—Ç', past: '–±–µ–∂–∞–ª/–±–µ–∂–∞–ª–∞', future: '–ø–æ–±–µ–∂–∏—Ç' },
                'swim': { present: '–ø–ª–∞–≤–∞–µ—Ç', past: '–ø–ª–∞–≤–∞–ª/–ø–ª–∞–≤–∞–ª–∞', future: '–±—É–¥–µ—Ç –ø–ª–∞–≤–∞—Ç—å' },
                
                // Actions
                'eat': { present: '–µ—Å—Ç', past: '–µ–ª/–µ–ª–∞', future: '–±—É–¥–µ—Ç –µ—Å—Ç—å' },
                'drink': { present: '–ø—å—ë—Ç', past: '–ø–∏–ª/–ø–∏–ª–∞', future: '–±—É–¥–µ—Ç –ø–∏—Ç—å' },
                'read': { present: '—á–∏—Ç–∞–µ—Ç', past: '—á–∏—Ç–∞–ª/—á–∏—Ç–∞–ª–∞', future: '–±—É–¥–µ—Ç —á–∏—Ç–∞—Ç—å' },
                'write': { present: '–ø–∏—à–µ—Ç', past: '–ø–∏—Å–∞–ª/–ø–∏—Å–∞–ª–∞', future: '–±—É–¥–µ—Ç –ø–∏—Å–∞—Ç—å' },
                'speak': { present: '–≥–æ–≤–æ—Ä–∏—Ç', past: '–≥–æ–≤–æ—Ä–∏–ª/–≥–æ–≤–æ—Ä–∏–ª–∞', future: '–±—É–¥–µ—Ç –≥–æ–≤–æ—Ä–∏—Ç—å' },
                'work': { present: '—Ä–∞–±–æ—Ç–∞–µ—Ç', past: '—Ä–∞–±–æ—Ç–∞–ª/—Ä–∞–±–æ—Ç–∞–ª–∞', future: '–±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å' },
                'study': { present: '—É—á–∏—Ç—Å—è', past: '—É—á–∏–ª—Å—è/—É—á–∏–ª–∞—Å—å', future: '–±—É–¥–µ—Ç —É—á–∏—Ç—å—Å—è' },
                'play': { present: '–∏–≥—Ä–∞–µ—Ç', past: '–∏–≥—Ä–∞–ª/–∏–≥—Ä–∞–ª–∞', future: '–±—É–¥–µ—Ç –∏–≥—Ä–∞—Ç—å' },
                
                // Creation/manipulation
                'make': { present: '–¥–µ–ª–∞–µ—Ç', past: '–¥–µ–ª–∞–ª/–¥–µ–ª–∞–ª–∞', future: '—Å–¥–µ–ª–∞–µ—Ç' },
                'build': { present: '—Å—Ç—Ä–æ–∏—Ç', past: '—Å—Ç—Ä–æ–∏–ª/—Å—Ç—Ä–æ–∏–ª–∞', future: '–ø–æ—Å—Ç—Ä–æ–∏—Ç' },
                'fix': { present: '—á–∏–Ω–∏—Ç', past: '—á–∏–Ω–∏–ª/—á–∏–Ω–∏–ª–∞', future: '–ø–æ—á–∏–Ω–∏—Ç' },
                'break': { present: '–ª–æ–º–∞–µ—Ç', past: '–ª–æ–º–∞–ª/–ª–æ–º–∞–ª–∞', future: '—Å–ª–æ–º–∞–µ—Ç' },
                'draw': { present: '—Ä–∏—Å—É–µ—Ç', past: '—Ä–∏—Å–æ–≤–∞–ª/—Ä–∏—Å–æ–≤–∞–ª–∞', future: '–Ω–∞—Ä–∏—Å—É–µ—Ç' },
                
                // Acquisition
                'buy': { present: '–ø–æ–∫—É–ø–∞–µ—Ç', past: '–∫—É–ø–∏–ª/–∫—É–ø–∏–ª–∞', future: '–∫—É–ø–∏—Ç' },
                'get': { present: '–ø–æ–ª—É—á–∞–µ—Ç', past: '–ø–æ–ª—É—á–∏–ª/–ø–æ–ª—É—á–∏–ª–∞', future: '–ø–æ–ª—É—á–∏—Ç' },
                'take': { present: '–±–µ—Ä—ë—Ç', past: '–≤–∑—è–ª/–≤–∑—è–ª–∞', future: '–≤–æ–∑—å–º—ë—Ç' },
                'bring': { present: '–ø—Ä–∏–Ω–æ—Å–∏—Ç', past: '–ø—Ä–∏–Ω—ë—Å/–ø—Ä–∏–Ω–µ—Å–ª–∞', future: '–ø—Ä–∏–Ω–µ—Å—ë—Ç' },
                'give': { present: '–¥–∞—ë—Ç', past: '–¥–∞–ª/–¥–∞–ª–∞', future: '–¥–∞—Å—Ç' },
                'find': { present: '–Ω–∞—Ö–æ–¥–∏—Ç', past: '–Ω–∞—à—ë–ª/–Ω–∞—à–ª–∞', future: '–Ω–∞–π–¥—ë—Ç' },
                
                // Mental/perception
                'think': { present: '–¥—É–º–∞–µ—Ç', past: '–¥—É–º–∞–ª/–¥—É–º–∞–ª–∞', future: '–±—É–¥–µ—Ç –¥—É–º–∞—Ç—å' },
                'know': { present: '–∑–Ω–∞–µ—Ç', past: '–∑–Ω–∞–ª/–∑–Ω–∞–ª–∞', future: '–±—É–¥–µ—Ç –∑–Ω–∞—Ç—å' },
                'understand': { present: '–ø–æ–Ω–∏–º–∞–µ—Ç', past: '–ø–æ–Ω–∏–º–∞–ª/–ø–æ–Ω–∏–º–∞–ª–∞', future: '–ø–æ–π–º—ë—Ç' },
                'see': { present: '–≤–∏–¥–∏—Ç', past: '–≤–∏–¥–µ–ª/–≤–∏–¥–µ–ª–∞', future: '—É–≤–∏–¥–∏—Ç' },
                'hear': { present: '—Å–ª—ã—à–∏—Ç', past: '—Å–ª—ã—à–∞–ª/—Å–ª—ã—à–∞–ª–∞', future: '—É—Å–ª—ã—à–∏—Ç' },
                'feel': { present: '—á—É–≤—Å—Ç–≤—É–µ—Ç', past: '—á—É–≤—Å—Ç–≤–æ–≤–∞–ª/—á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∞', future: '–ø–æ—á—É–≤—Å—Ç–≤—É–µ—Ç' },
                
                // Other common verbs
                'have': { present: '–∏–º–µ–µ—Ç', past: '–∏–º–µ–ª/–∏–º–µ–ª–∞', future: '–±—É–¥–µ—Ç –∏–º–µ—Ç—å' },
                'do': { present: '–¥–µ–ª–∞–µ—Ç', past: '–¥–µ–ª–∞–ª/–¥–µ–ª–∞–ª–∞', future: '—Å–¥–µ–ª–∞–µ—Ç' },
                'say': { present: '–≥–æ–≤–æ—Ä–∏—Ç', past: '—Å–∫–∞–∑–∞–ª/—Å–∫–∞–∑–∞–ª–∞', future: '—Å–∫–∞–∂–µ—Ç' },
                'tell': { present: '—Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç', past: '—Ä–∞—Å—Å–∫–∞–∑–∞–ª/—Ä–∞—Å—Å–∫–∞–∑–∞–ª–∞', future: '—Ä–∞—Å—Å–∫–∞–∂–µ—Ç' },
                'meet': { present: '–≤—Å—Ç—Ä–µ—á–∞–µ—Ç', past: '–≤—Å—Ç—Ä–µ—Ç–∏–ª/–≤—Å—Ç—Ä–µ—Ç–∏–ª–∞', future: '–≤—Å—Ç—Ä–µ—Ç–∏—Ç' },
                'leave': { present: '—É—Ö–æ–¥–∏—Ç', past: '—É—à—ë–ª/—É—à–ª–∞', future: '—É–π–¥—ë—Ç' },
                'sleep': { present: '—Å–ø–∏—Ç', past: '—Å–ø–∞–ª/—Å–ø–∞–ª–∞', future: '–±—É–¥–µ—Ç —Å–ø–∞—Ç—å' },
                'sit': { present: '—Å–∏–¥–∏—Ç', past: '—Å–∏–¥–µ–ª/—Å–∏–¥–µ–ª–∞', future: '–±—É–¥–µ—Ç —Å–∏–¥–µ—Ç—å' },
                'stand': { present: '—Å—Ç–æ–∏—Ç', past: '—Å—Ç–æ—è–ª/—Å—Ç–æ—è–ª–∞', future: '–±—É–¥–µ—Ç —Å—Ç–æ—è—Ç—å' },
                'begin': { present: '–Ω–∞—á–∏–Ω–∞–µ—Ç', past: '–Ω–∞—á–∞–ª/–Ω–∞—á–∞–ª–∞', future: '–Ω–∞—á–Ω—ë—Ç' },
                'become': { present: '—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è', past: '—Å—Ç–∞–ª/—Å—Ç–∞–ª–∞', future: '—Å—Ç–∞–Ω–µ—Ç' },
                'teach': { present: '—É—á–∏—Ç', past: '—É—á–∏–ª/—É—á–∏–ª–∞', future: '–Ω–∞—É—á–∏—Ç' },
                'learn': { present: '—É—á–∏—Ç—Å—è', past: '—É—á–∏–ª—Å—è/—É—á–∏–ª–∞—Å—å', future: '–Ω–∞—É—á–∏—Ç—Å—è' },
                'choose': { present: '–≤—ã–±–∏—Ä–∞–µ—Ç', past: '–≤—ã–±—Ä–∞–ª/–≤—ã–±—Ä–∞–ª–∞', future: '–≤—ã–±–µ—Ä–µ—Ç' },
                'fall': { present: '–ø–∞–¥–∞–µ—Ç', past: '—É–ø–∞–ª/—É–ø–∞–ª–∞', future: '—É–ø–∞–¥—ë—Ç' },
                'grow': { present: '—Ä–∞—Å—Ç—ë—Ç', past: '—Ä–æ—Å/—Ä–æ—Å–ª–∞', future: '–≤—ã—Ä–∞—Å—Ç–µ—Ç' },
                'throw': { present: '–±—Ä–æ—Å–∞–µ—Ç', past: '–±—Ä–æ—Å–∏–ª/–±—Ä–æ—Å–∏–ª–∞', future: '–±—Ä–æ—Å–∏—Ç' },
                'catch': { present: '–ª–æ–≤–∏—Ç', past: '–ø–æ–π–º–∞–ª/–ø–æ–π–º–∞–ª–∞', future: '–ø–æ–π–º–∞–µ—Ç' },
                'sing': { present: '–ø–æ—ë—Ç', past: '–ø–µ–ª/–ø–µ–ª–∞', future: '—Å–ø–æ—ë—Ç' },
                'cost': { present: '—Å—Ç–æ–∏—Ç', past: '—Å—Ç–æ–∏–ª/—Å—Ç–æ–∏–ª–∞', future: '–±—É–¥–µ—Ç —Å—Ç–æ–∏—Ç—å' },
                'put': { present: '–∫–ª–∞–¥—ë—Ç', past: '–ø–æ–ª–æ–∂–∏–ª/–ø–æ–ª–æ–∂–∏–ª–∞', future: '–ø–æ–ª–æ–∂–∏—Ç' },
                'show': { present: '–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç', past: '–ø–æ–∫–∞–∑–∞–ª/–ø–æ–∫–∞–∑–∞–ª–∞', future: '–ø–æ–∫–∞–∂–µ—Ç' },
                'seek': { present: '–∏—â–µ—Ç', past: '–∏—Å–∫–∞–ª/–∏—Å–∫–∞–ª–∞', future: '–±—É–¥–µ—Ç –∏—Å–∫–∞—Ç—å' },
                'lie': { present: '–ª–µ–∂–∏—Ç', past: '–ª–µ–∂–∞–ª/–ª–µ–∂–∞–ª–∞', future: '–±—É–¥–µ—Ç –ª–µ–∂–∞—Ç—å' },
                'beat': { present: '–±—å—ë—Ç', past: '–±–∏–ª/–±–∏–ª–∞', future: '–ø–æ–±—å—ë—Ç' },
                'dream': { present: '–º–µ—á—Ç–∞–µ—Ç', past: '–º–µ—á—Ç–∞–ª/–º–µ—á—Ç–∞–ª–∞', future: '–±—É–¥–µ—Ç –º–µ—á—Ç–∞—Ç—å' },
                
                // Be verb special handling
                'be': { present: '–µ—Å—Ç—å', past: '–±—ã–ª/–±—ã–ª–∞/–±—ã–ª–æ', future: '–±—É–¥–µ—Ç' }
            };
            
            const rusSubject = russianSubjects[subject] || subject;
            const verbForms = verbTranslations[verb] || { 
                present: '–¥–µ–ª–∞–µ—Ç', 
                past: '–¥–µ–ª–∞–ª/–¥–µ–ª–∞–ª–∞', 
                future: '–±—É–¥–µ—Ç –¥–µ–ª–∞—Ç—å' 
            };
            
            // Get the appropriate verb form
            let verbForm = verbForms[tense];
            
            // Handle gender/number agreement for past tense
            if (tense === 'past' && verbForm.includes('/')) {
                const forms = verbForm.split('/');
                if (subject === 'he' || subject === 'I' || subject === 'you') {
                    verbForm = forms[0]; // masculine
                } else if (subject === 'she') {
                    verbForm = forms[1]; // feminine
                } else if (subject === 'it') {
                    verbForm = forms[2] || forms[1]; // neuter
                } else {
                    verbForm = forms[0].replace(/–ª$/, '–ª–∏'); // plural
                }
            }
            
            // Conjugate for present tense
            if (tense === 'present') {
                // Simple conjugation adjustment for 1st person
                if (subject === 'I') {
                    verbForm = verbForm.replace(/–µ—Ç$/, '—é').replace(/–∏—Ç$/, '—é').replace(/—ë—Ç$/, '—é');
                } else if (subject === 'you') {
                    verbForm = verbForm.replace(/–µ—Ç$/, '–µ—à—å').replace(/–∏—Ç$/, '–∏—à—å').replace(/—ë—Ç$/, '—ë—à—å');
                } else if (subject === 'we') {
                    verbForm = verbForm.replace(/–µ—Ç$/, '–µ–º').replace(/–∏—Ç$/, '–∏–º').replace(/—ë—Ç$/, '—ë–º');
                } else if (subject === 'they') {
                    verbForm = verbForm.replace(/–µ—Ç$/, '—é—Ç').replace(/–∏—Ç$/, '—è—Ç').replace(/—ë—Ç$/, '—é—Ç');
                }
            }
            
            // Conjugate for future tense
            if (tense === 'future' && !verbForm.includes('–±—É–¥–µ—Ç')) {
                // Perfective future conjugation
                if (subject === 'I') {
                    verbForm = verbForm.replace(/—ë—Ç$/, '—É').replace(/–µ—Ç$/, '—É').replace(/–∏—Ç$/, '—É');
                } else if (subject === 'you') {
                    verbForm = verbForm.replace(/—ë—Ç$/, '—ë—à—å').replace(/–µ—Ç$/, '–µ—à—å').replace(/–∏—Ç$/, '–∏—à—å');
                } else if (subject === 'we') {
                    verbForm = verbForm.replace(/—ë—Ç$/, '—ë–º').replace(/–µ—Ç$/, '–µ–º').replace(/–∏—Ç$/, '–∏–º');
                } else if (subject === 'they') {
                    verbForm = verbForm.replace(/—ë—Ç$/, '—É—Ç').replace(/–µ—Ç$/, '—É—Ç').replace(/–∏—Ç$/, '—è—Ç');
                }
            }
            
            return rusSubject + ' ' + verbForm;
        }
        
        function getVerbFormForSubject(subject, verb) {
            const isThirdPerson = ['he', 'she', 'it'].includes(subject.toLowerCase());
            
            if (verb === 'be') {
                if (subject === 'I') return 'am';
                if (isThirdPerson) return 'is';
                return 'are';
            }
            
            if (!isThirdPerson) return verb;
            
            if (verb === 'have') return 'has';
            if (verb === 'do') return 'does';
            
            if (verb.endsWith('y') && !['a','e','i','o','u'].includes(verb[verb.length-2])) {
                return verb.slice(0, -1) + 'ies';
            } else if (verb.endsWith('o') || verb.endsWith('s') || verb.endsWith('x') || verb.endsWith('ch') || verb.endsWith('sh')) {
                return verb + 'es';
            }
            return verb + 's';
        }
        
        function getPastForm(verb) {
            const irregulars = {
                'go': 'went', 'get': 'got', 'eat': 'ate', 'take': 'took', 'make': 'made',
                'write': 'wrote', 'speak': 'spoke', 'read': 'read', 'be': 'was/were',
                'beat': 'beat', 'become': 'became', 'begin': 'began',
                'break': 'broke', 'bring': 'brought', 'build': 'built',
                'buy': 'bought', 'catch': 'caught', 'choose': 'chose',
                'come': 'came', 'cost': 'cost', 'do': 'did',
                'draw': 'drew', 'dream': 'dreamt', 'drink': 'drank',
                'drive': 'drove', 'fall': 'fell', 'feel': 'felt',
                'find': 'found', 'fly': 'flew', 'give': 'gave',
                'grow': 'grew', 'have': 'had', 'hear': 'heard',
                'know': 'knew', 'learn': 'learnt', 'leave': 'left',
                'lie': 'lay', 'meet': 'met', 'put': 'put',
                'run': 'ran', 'say': 'said', 'see': 'saw',
                'seek': 'sought', 'show': 'showed', 'sing': 'sang',
                'sit': 'sat', 'sleep': 'slept', 'stand': 'stood',
                'swim': 'swam', 'teach': 'taught', 'tell': 'told',
                'think': 'thought', 'throw': 'threw', 'understand': 'understood'
            };
            return irregulars[verb] || verb + 'ed';
        }
        
        function revealNext() {
            const elements = [
                'englishPositive',
                'englishNegative', 
                'englishQuestion',
                'englishWhQuestion'
            ];
            
            if (revealStage < elements.length) {
                const element = document.getElementById(elements[revealStage]);
                element.classList.remove('hidden');
                element.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';
                revealStage++;
                
                // Mark as complete when all revealed
                if (revealStage === elements.length) {
                    document.getElementById('testContainer').classList.add('complete');
                }
            }
        }

        function playAudioPast() {
            const sentences = [
                document.getElementById('sentencePast1').textContent,
                document.getElementById('sentencePast2').textContent,
                document.getElementById('sentencePast3').textContent,
                document.getElementById('sentencePast4').textContent
            ];
            
            let index = 0;
            function speakNext() {
                if (index < sentences.length) {
                    speak(sentences[index]);
                    index++;
                    setTimeout(speakNext, 2000);
                }
            }
            speakNext();
        }

        function playAudioFuture() {
            const sentences = [
                document.getElementById('sentenceFuture1').textContent,
                document.getElementById('sentenceFuture2').textContent,
                document.getElementById('sentenceFuture3').textContent,
                document.getElementById('sentenceFuture4').textContent
            ];
            
            let index = 0;
            function speakNext() {
                if (index < sentences.length) {
                    speak(sentences[index]);
                    index++;
                    setTimeout(speakNext, 2000);
                }
            }
            speakNext();
        }
        
        function startFutureSimple() {
            showScreen('futureSimple');
            currentSubjectIndexFuture = 0;
            updateFutureSimpleDisplay();
        }

        // Exercise functions
        async function updateExerciseDisplay() {
            if (isLoading) return;
            
            const subject = allSubjects[currentSubjectIndex];
            
            // Show loading state
            setLoadingState(true);
            
            try {
                // Call your backend API which will use Anthropic
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        subject: subject,
                        verb: currentVerb,
                        tense: 'present'
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                
                // Update sentences with API response
                document.getElementById('sentence1').textContent = data.sentences[0];
                document.getElementById('sentence2').textContent = data.sentences[1];
                document.getElementById('sentence3').textContent = data.sentences[2];
                document.getElementById('sentence4').textContent = data.sentences[3];
                
                // Update scheme info
                document.getElementById('schemeInfo').textContent = data.schemeInfo;
                
                // Hide error message
                document.getElementById('errorMessage').classList.add('hidden');
                
            } catch (error) {
                console.error('Error:', error);
                showError('Failed to generate sentences. Using fallback logic.');
                useFallbackLogic(subject);
            } finally {
                setLoadingState(false);
            }
            
            // Update navigation buttons (never disable them since we loop)
            // Update verb info
            document.getElementById('currentVerb').textContent = `Current verb: ${currentVerb}`;
        }

        function setLoadingState(loading) {
            isLoading = loading;
            const buttons = ['backBtn', 'nextBtn', 'changeWordBtn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) btn.disabled = loading;
            });
            
            if (loading) {
                document.querySelectorAll('.sentence').forEach(el => {
                    el.innerHTML = 'Generating... <span class="loading"></span>';
                });
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        function useFallbackLogic(subject) {
            // Simple fallback logic when API fails
            const isThirdPersonSingular = ['he', 'she', 'it'].includes(subject.toLowerCase());
            
            let verbForm = currentVerb;
            let aux = 'do';
            let auxNeg = "don't";
            let whWord = getWhWord(currentVerb);
            
            // Special cases for irregular present forms
            if (currentVerb === 'be') {
                if (subject.toLowerCase() === 'i') {
                    verbForm = 'am';
                } else if (isThirdPersonSingular) {
                    verbForm = 'is';
                } else {
                    verbForm = 'are';
                }
            } else if (currentVerb === 'have' && isThirdPersonSingular) {
                verbForm = 'has';
            } else if (currentVerb === 'do' && isThirdPersonSingular) {
                verbForm = 'does';
            } else if (isThirdPersonSingular) {
                aux = 'does';
                auxNeg = "doesn't";
                // Handle third person singular forms
                if (currentVerb.endsWith('y') && !['a','e','i','o','u'].includes(currentVerb[currentVerb.length-2])) {
                    verbForm = currentVerb.slice(0, -1) + 'ies'; // study ‚Üí studies
                } else if (currentVerb.endsWith('o') || currentVerb.endsWith('s') || currentVerb.endsWith('x') || currentVerb.endsWith('ch') || currentVerb.endsWith('sh')) {
                    verbForm = currentVerb + 'es'; // go ‚Üí goes, fix ‚Üí fixes
                } else {
                    verbForm = currentVerb + 's'; // eat ‚Üí eats
                }
            }
            
            // For 'be', we don't use do/does in questions
            if (currentVerb === 'be') {
                document.getElementById('sentence1').textContent = `${subject} ${verbForm}`;
                document.getElementById('sentence2').textContent = `${subject} ${verbForm} not`;
                document.getElementById('sentence3').textContent = `${verbForm.charAt(0).toUpperCase() + verbForm.slice(1)} ${subject}?`;
                document.getElementById('sentence4').textContent = `${whWord} ${verbForm} ${subject}?`;
            } else {
                document.getElementById('sentence1').textContent = `${subject} ${verbForm}`;
                document.getElementById('sentence2').textContent = `${subject} ${auxNeg} ${currentVerb}`;
                document.getElementById('sentence3').textContent = `${aux.charAt(0).toUpperCase() + aux.slice(1)} ${subject} ${currentVerb}?`;
                document.getElementById('sentence4').textContent = `${whWord} ${aux} ${subject} ${currentVerb}?`;
            }
            
            document.getElementById('schemeInfo').textContent = isThirdPersonSingular ? 
                'Scheme 2: he/she/it forms (third person singular)' : 
                'Scheme 1: I/you/we/they forms';
        }
        
        function getWhWord(verb) {
            const whWords = {
                // Movement verbs
                'go': 'Where', 'come': 'Where', 'drive': 'Where', 'fly': 'Where', 
                'run': 'Where', 'walk': 'Where', 'swim': 'Where', 'sit': 'Where',
                'stand': 'Where', 'put': 'Where', 'throw': 'Where', 'fall': 'Where', 'be': 'Where',
                
                // Action/creation verbs
                'do': 'What', 'make': 'What', 'say': 'What', 'eat': 'What',
                'drink': 'What', 'buy': 'What', 'read': 'What', 'write': 'What',
                'draw': 'What', 'build': 'What', 'fix': 'What', 'choose': 'What',
                'think': 'What', 'dream': 'What', 'break': 'What', 'catch': 'What',
                'give': 'What', 'take': 'What', 'bring': 'What', 'see': 'What',
                'hear': 'What', 'feel': 'What', 'have': 'What', 'get': 'What',
                'find': 'What', 'seek': 'What', 'show': 'What', 'sing': 'What',
                
                // People-related verbs
                'meet': 'Who', 'teach': 'Who', 'beat': 'Who', 'tell': 'Who', 'know': 'Who',
                
                // Time-related verbs
                'begin': 'When', 'leave': 'When', 'sleep': 'When', 'work': 'When',
                'study': 'When', 'play': 'When',
                
                // Cost
                'cost': 'How much',
                
                // Reason
                'cry': 'Why', 'understand': 'Why',
                
                // Manner
                'speak': 'How', 'grow': 'How', 'learn': 'How', 'lie': 'How'
            };
            
            return whWords[verb] || 'What';
        }

        function nextSubject() {
            if (!isLoading) {
                currentSubjectIndex++;
                if (currentSubjectIndex >= allSubjects.length) {
                    currentSubjectIndex = 0; // Loop back to beginning
                }
                updateExerciseDisplay();
            }
        }

        function previousSubject() {
            if (!isLoading) {
                currentSubjectIndex--;
                if (currentSubjectIndex < 0) {
                    currentSubjectIndex = allSubjects.length - 1; // Loop to end
                }
                updateExerciseDisplay();
            }
        }

        function changeVerb() {
            if (isLoading) return;
            
            // Get a random verb different from the current one
            let newVerb;
            do {
                newVerb = verbs[Math.floor(Math.random() * verbs.length)];
            } while (newVerb === currentVerb);
            
            currentVerb = newVerb;
            
            // Get a random subject
            currentSubjectIndex = Math.floor(Math.random() * allSubjects.length);
            
            updateExerciseDisplay();
        }

        // Past Simple Exercise Functions
        async function updatePastSimpleDisplay() {
            if (isLoading) return;
            
            const subject = allSubjects[currentSubjectIndexPast];
            
            // Show loading state
            setLoadingStatePast(true);
            
            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        subject: subject,
                        verb: currentVerbPast,
                        tense: 'past'
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                
                // Update sentences with API response
                document.getElementById('sentencePast1').textContent = data.sentences[0];
                document.getElementById('sentencePast2').textContent = data.sentences[1];
                document.getElementById('sentencePast3').textContent = data.sentences[2];
                document.getElementById('sentencePast4').textContent = data.sentences[3];
                
                // Update scheme info
                document.getElementById('schemeInfoPast').textContent = 'Past Simple: same form for all subjects';
                
                // Hide error message
                document.getElementById('errorMessagePast').classList.add('hidden');
                
            } catch (error) {
                console.error('Error:', error);
                showErrorPast('Failed to generate sentences. Using fallback logic.');
                useFallbackLogicPast(subject);
            } finally {
                setLoadingStatePast(false);
            }
            
            // Update navigation buttons (never disable them since we loop)
            // Update verb info
            document.getElementById('currentVerbPast').textContent = `Current verb: ${currentVerbPast}`;
        }

        function setLoadingStatePast(loading) {
            isLoading = loading;
            const buttons = ['backBtnPast', 'nextBtnPast', 'changeWordBtnPast'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) btn.disabled = loading;
            });
            
            if (loading) {
                document.querySelectorAll('#sentenceDisplayPast .sentence').forEach(el => {
                    el.innerHTML = 'Generating... <span class="loading"></span>';
                });
            }
        }

        function showErrorPast(message) {
            const errorEl = document.getElementById('errorMessagePast');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        function useFallbackLogicPast(subject) {
            // Simple fallback for past tense
            const irregularPast = {
                'go': 'went', 'get': 'got', 'eat': 'ate', 
                'take': 'took', 'make': 'made', 'write': 'wrote',
                'speak': 'spoke', 'read': 'read', 'be': 'was/were',
                'beat': 'beat', 'become': 'became', 'begin': 'began',
                'break': 'broke', 'bring': 'brought', 'build': 'built',
                'buy': 'bought', 'catch': 'caught', 'choose': 'chose',
                'come': 'came', 'cost': 'cost', 'do': 'did',
                'draw': 'drew', 'dream': 'dreamt', 'drink': 'drank',
                'drive': 'drove', 'fall': 'fell', 'feel': 'felt',
                'find': 'found', 'fly': 'flew', 'give': 'gave',
                'grow': 'grew', 'have': 'had', 'hear': 'heard',
                'know': 'knew', 'learn': 'learnt', 'leave': 'left',
                'lie': 'lay', 'meet': 'met', 'put': 'put',
                'run': 'ran', 'say': 'said', 'see': 'saw',
                'seek': 'sought', 'show': 'showed', 'sing': 'sang',
                'sit': 'sat', 'sleep': 'slept', 'stand': 'stood',
                'swim': 'swam', 'teach': 'taught', 'tell': 'told',
                'think': 'thought', 'throw': 'threw', 'understand': 'understood'
            };
            
            let pastForm = irregularPast[currentVerbPast] || currentVerbPast + 'ed';
            let whWord = getWhWord(currentVerbPast);
            
            // Special handling for 'be'
            if (currentVerbPast === 'be') {
                if (['I', 'he', 'she', 'it'].includes(subject)) {
                    pastForm = 'was';
                } else {
                    pastForm = 'were';
                }
                
                document.getElementById('sentencePast1').textContent = `${subject} ${pastForm}`;
                document.getElementById('sentencePast2').textContent = `${subject} ${pastForm}n't`;
                document.getElementById('sentencePast3').textContent = `${pastForm.charAt(0).toUpperCase() + pastForm.slice(1)} ${subject}?`;
                document.getElementById('sentencePast4').textContent = `${whWord} ${pastForm} ${subject}?`;
            } else {
                document.getElementById('sentencePast1').textContent = `${subject} ${pastForm}`;
                document.getElementById('sentencePast2').textContent = `${subject} didn't ${currentVerbPast}`;
                document.getElementById('sentencePast3').textContent = `Did ${subject} ${currentVerbPast}?`;
                document.getElementById('sentencePast4').textContent = `${whWord} did ${subject} ${currentVerbPast}?`;
            }
            
            document.getElementById('schemeInfoPast').textContent = 'Past Simple: same form for all subjects';
        }

        function nextSubjectPast() {
            if (!isLoading) {
                currentSubjectIndexPast++;
                if (currentSubjectIndexPast >= allSubjects.length) {
                    currentSubjectIndexPast = 0; // Loop back to beginning
                }
                updatePastSimpleDisplay();
            }
        }

        function previousSubjectPast() {
            if (!isLoading) {
                currentSubjectIndexPast--;
                if (currentSubjectIndexPast < 0) {
                    currentSubjectIndexPast = allSubjects.length - 1; // Loop to end
                }
                updatePastSimpleDisplay();
            }
        }

        function changeVerbPast() {
            if (isLoading) return;
            
            // Get a random verb different from the current one
            let newVerb;
            do {
                newVerb = verbs[Math.floor(Math.random() * verbs.length)];
            } while (newVerb === currentVerbPast);
            
            currentVerbPast = newVerb;
            
            // Get a random subject
            currentSubjectIndexPast = Math.floor(Math.random() * allSubjects.length);
            
            updatePastSimpleDisplay();
        }
    </script>
</body>
</html>
